name: Bootstrap Android Signing Secrets

on:
  workflow_dispatch:
    inputs:
      KEY_ALIAS:
        description: 'Android key alias (default vinor_release)'
        required: false
        default: 'vinor_release'
      KEY_VALIDITY_DAYS:
        description: 'Key validity in days'
        required: false
        default: '36500'

concurrency:
  group: bootstrap-secrets-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      KEY_ALIAS: ${{ inputs.KEY_ALIAS }}
      KEY_VALIDITY_DAYS: ${{ inputs.KEY_VALIDITY_DAYS }}
    steps:
      - name: Check admin token is available
        shell: bash
        env:
          GH_ADMIN_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          if [ -z "$GH_ADMIN_TOKEN" ]; then
            echo "GH_ADMIN_TOKEN secret is not set. Create a repository secret named GH_ADMIN_TOKEN with a Personal Access Token that has 'repo' scope."
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Generate random passwords
        id: rnd
        shell: bash
        run: |
          rand() { tr -dc 'A-Za-z0-9' </dev/urandom | head -c 32 ; echo ; }
          STORE_PASS="$(rand)"
          KEY_PASS="$(rand)"
          echo "STORE_PASS=$STORE_PASS" >> $GITHUB_OUTPUT
          echo "KEY_PASS=$KEY_PASS" >> $GITHUB_OUTPUT

      - name: Generate keystore (ephemeral)
        shell: bash
        env:
          STORE_PASS: ${{ steps.rnd.outputs.STORE_PASS }}
          KEY_PASS: ${{ steps.rnd.outputs.KEY_PASS }}
          KEY_ALIAS: ${{ env.KEY_ALIAS }}
          KEY_VALIDITY_DAYS: ${{ env.KEY_VALIDITY_DAYS }}
        run: |
          mkdir -p app/keystore
          keytool -genkeypair -v \
            -keystore app/keystore/vinor-release.jks \
            -alias "$KEY_ALIAS" \
            -keyalg RSA -keysize 2048 -validity "$KEY_VALIDITY_DAYS" \
            -storepass "$STORE_PASS" -keypass "$KEY_PASS" \
            -dname "CN=vinor,O=vinor,L=Tehran,C=IR"
          test -s app/keystore/vinor-release.jks

      - name: Create base64 for secret
        id: b64
        shell: bash
        run: |
          B64=$(base64 -w 0 app/keystore/vinor-release.jks)
          echo "B64=$B64" >> $GITHUB_OUTPUT

      - name: Configure GitHub CLI
        shell: bash
        env:
          GH_ADMIN_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          echo "$GH_ADMIN_TOKEN" | gh auth login --with-token
          gh auth status

      - name: Set repository secrets
        shell: bash
        env:
          B64: ${{ steps.b64.outputs.B64 }}
          STORE_PASS: ${{ steps.rnd.outputs.STORE_PASS }}
          KEY_PASS: ${{ steps.rnd.outputs.KEY_PASS }}
          KEY_ALIAS: ${{ env.KEY_ALIAS }}
        run: |
          gh secret set ANDROID_KEYSTORE_BASE64 -b"$B64"
          gh secret set ANDROID_KEYSTORE_PASSWORD -b"$STORE_PASS"
          gh secret set ANDROID_KEY_ALIAS -b"$KEY_ALIAS"
          gh secret set ANDROID_KEY_PASSWORD -b"$KEY_PASS"
          echo "Repository secrets created/updated."

      - name: Summary
        run: |
          echo "Secrets set: ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD"
          echo "KEY_ALIAS=${{ env.KEY_ALIAS }}"
          echo "You can now run the Android Direct APK workflow."


